---
import Card from "@ui/Card.astro";
import Button from "@ui/Button.astro";
import Badge from "@ui/Badge.astro";
import { Icon } from "astro-icon/components";

// Fonction d'aide pour parser les tableaux JSON stockés sous forme de string
function parseJsonArray(data: unknown): unknown[] {
  if (!data) return [];
  if (typeof data === 'string') {
    try {
      return JSON.parse(data);
    } catch {
      return [];
    }
  }
  return Array.isArray(data) ? data : [];
}

// Préparation des données
const tags = parseJsonArray(Astro.props.entry.tags) as string[];
const steps = parseJsonArray(Astro.props.entry.steps) as string[];

// Calcul de la note moyenne (si des avis sont disponibles)
let averageRating = 0;
let ratingCount = 0;
if (Astro.props.entry.avis && Array.isArray(Astro.props.entry.avis) && Astro.props.entry.avis.length > 0) {
  const sum = Astro.props.entry.avis.reduce((acc: number, avis: { note?: number }) => acc + (avis.note || 0), 0);
  averageRating = sum / Astro.props.entry.avis.length;
  ratingCount = Astro.props.entry.avis.length;
}

// Formatage du prix
const formattedPrice = new Intl.NumberFormat('fr-FR', { 
  style: 'currency', 
  currency: 'EUR',
  minimumFractionDigits: 0,
  maximumFractionDigits: 0 
}).format(Astro.props.entry.prix);

// Compteurs pour les galeries et FAQ
const galerieCount = Astro.props.entry.galerie?.length || 0;
const faqCount = Astro.props.entry.faq?.length || 0;
---

<Card padding="lg" variant="default" class="service-card">
  <div class="service-card-content">
    <div class="service-card-image-block">
      {Astro.props.entry.image && (
        <div class="service-card-image-wrapper">
          <img
            src={Astro.props.entry.image}
            alt={Astro.props.entry.imageAlt || Astro.props.entry.nom}
            class="service-card-img"
          />
          {Astro.props.entry.isFeatured === 1 && (
            <div class="service-card-featured-badge">
              <Badge variant="primary" size="sm">Populaire</Badge>
            </div>
          )}
          {Astro.props.entry.categorie && (
            <div class="service-card-category-badge">
              <Badge variant="secondary" size="sm">{Astro.props.entry.categorie}</Badge>
            </div>
          )}
        </div>
      )}
      {!Astro.props.entry.image && Astro.props.entry.icon && (
        <div class="service-card-icon-block">
          <Icon name={Astro.props.entry.icon} class="service-card-icon" />
        </div>
      )}
      {!Astro.props.entry.image && !Astro.props.entry.icon && (
        <div class="service-card-empty-block"></div>
      )}
      <div class="service-card-info">
        <h3 class="service-card-title">{Astro.props.entry.nom}</h3>
  {ratingCount > 0 && (
            <div class="service-card-rating-row">
              <div class="service-card-rating-stars" aria-label={`Note: ${averageRating.toFixed(1)} sur 5`}>
                {/* Étoile 1 */}
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class={`service-card-star${averageRating >= 1 ? ' active' : ''}`}> 
                  <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" />
                </svg>
                {/* Étoile 2 */}
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class={`service-card-star${averageRating >= 2 ? ' active' : ''}`}> 
                  <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" />
                </svg>
                {/* Étoile 3 */}
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class={`service-card-star${averageRating >= 3 ? ' active' : ''}`}> 
                  <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" />
                </svg>
                {/* Étoile 4 */}
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class={`service-card-star${averageRating >= 4 ? ' active' : ''}`}> 
                  <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" />
                </svg>
                {/* Étoile 5 */}
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class={`service-card-star${averageRating >= 5 ? ' active' : ''}`}> 
                  <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" />
                </svg>
              </div>
              <span class="text-sm font-semibold">{averageRating.toFixed(1)}</span>
              <span class="text-xs text-muted-foreground ml-1">({ratingCount} avis)</span>
            </div>
          )}
        </div>
        
        {/* Description */}
  <p class="service-card-description">
          {Astro.props.entry.description}
        </p>
        
        {/* Infos clés avec des icônes */}
  <div class="service-card-infos">
          {/* Durée */}
          <div class="service-card-info-block">
            <Icon name="mdi:clock" class="service-card-info-icon" />
            <p class="service-card-info-label">Durée</p>
            <p class="service-card-info-value">{Astro.props.entry.duree || (Astro.props.entry.durationMinutes ? `${Astro.props.entry.durationMinutes} min` : 'Variable')}</p>
          </div>
          
          {/* Catégorie */}
          <div class="service-card-info-block">
            <Icon name="mdi:tag" class="service-card-info-icon" />
            <p class="service-card-info-label">Catégorie</p>
            <p class="service-card-info-value">{Astro.props.entry.categorie || 'Général'}</p>
          </div>
          
          {/* Photos */}
          <div class="service-card-info-block">
            <Icon name="mdi:image-multiple" class="service-card-info-icon" />
            <p class="service-card-info-label">Photos</p>
            <p class="service-card-info-value">{galerieCount || '0'}</p>
          </div>
        </div>
        
        {/* Étapes / Features */}
        {steps.length > 0 && (
          <div class="service-card-steps">
            <h4 class="service-card-steps-title">Ce service comprend :</h4>
            <ul class="service-card-steps-list">
              {steps.slice(0, 3).map((step: string) => (
                <li class="service-card-step">
                  <Icon name="mdi:check-circle" class="service-card-step-icon" />
                  {step}
                </li>
              ))}
              {steps.length > 3 && (
                <li class="service-card-step-more">+ {steps.length - 3} autres étapes</li>
              )}
            </ul>
          </div>
        )}
        
        {/* Tags */}
        {tags.length > 0 && (
          <div class="service-card-tags">
            {tags.slice(0, 3).map((tag: string) => (
              <Badge variant="default">{tag}</Badge>
            ))}
            {tags.length > 3 && (
              <Badge variant="default">+{tags.length - 3} autres</Badge>
            )}
          </div>
        )}
        
        {/* Information sur FAQ */}
        {faqCount > 0 && (
          <div class="service-card-faq-info">
            <Icon name="mdi:frequently-asked-questions" class="service-card-faq-icon" />
            <span class="service-card-faq-text">{faqCount} question{faqCount > 1 ? 's' : ''} fréquente{faqCount > 1 ? 's' : ''}</span>
          </div>
        )}
        
        {/* Prix et bouton d'action */}
  <div class="service-card-action-row">
          <div class="service-card-price-block">
            <span class="service-card-price">{formattedPrice}</span>
            <span class="service-card-price-unit">/ session</span>
          </div>
          <Button 
            href={`/services/${Astro.props.entry.slug}`}
            variant="primary"
            size="md"
          >
            Réserver
            <Icon name="mdi:arrow-right" class="service-card-action-icon" />
          </Button>
        </div>
            </div>
    </div>
  </div>
</Card>
<style>
  .service-card-rating-row {
    display: flex;
    align-items: center;
    margin-top: var(--space-2);
  }
  .service-card-rating-stars {
    display: flex;
    align-items: center;
    margin-right: var(--space-2);
  }
  .service-card {
    background: var(--theme-card);
    color: var(--theme-card-foreground);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    padding: var(--space-8);
    transition: box-shadow 0.2s;
  }
  .service-card-content { }
  .service-card-img {
    width: 100%;
    height: 192px;
    object-fit: cover;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    background: var(--theme-muted);
  }
  .service-card-image-wrapper {
    position: relative;
    width: 100%;
    height: 192px;
  }
  .service-card-featured-badge {
    position: absolute;
    top: var(--space-4);
    right: var(--space-4);
    z-index: 2;
    pointer-events: none;
  }
  .service-card-category-badge {
    position: absolute;
    top: calc(var(--space-4));
    left: var(--space-4);
    z-index: 2;
    pointer-events: none;
  }
  .service-card-icon-block {
    height: 192px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--theme-primary-50);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  }
  .service-card-icon {
    width: 64px;
    height: 64px;
    color: var(--theme-primary);
  }
  .service-card-empty-block {
    height: var(--space-8);
  }
  .service-card-title {
    font-size: 2rem;
    font-weight: bold;
    color: var(--theme-foreground);
    margin-bottom: var(--space-2);
  }
  .service-card-description {
    color: var(--theme-muted-foreground);
    line-height: 1.6;
  }
  .service-card-infos {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-4);
    padding: var(--space-4) 0;
    border-top: 1px solid var(--theme-border);
    border-bottom: 1px solid var(--theme-border);
  }
  .service-card-info-block {
    text-align: center;
  }
  .service-card-info-icon {
    width: 20px;
    height: 20px;
    color: var(--theme-primary);
    margin: 0 auto var(--space-1);
  }
  .service-card-info-label {
    font-size: 0.85rem;
    color: var(--theme-muted-foreground);
    margin-bottom: var(--space-1);
  }
  .service-card-info-value {
    font-size: 1rem;
    font-weight: 500;
    color: var(--theme-foreground);
  }
  .service-card-steps {
    margin-top: var(--space-4);
  }
  .service-card-steps-title {
    font-weight: 600;
    color: var(--theme-foreground);
    margin-bottom: var(--space-2);
  }
  .service-card-steps-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .service-card-step {
    display: flex;
    align-items: center;
    font-size: 1rem;
    color: var(--theme-muted-foreground);
    margin-bottom: var(--space-2);
  }
  .service-card-step-icon {
    width: 16px;
    height: 16px;
    color: var(--theme-primary);
    margin-right: var(--space-3);
    flex-shrink: 0;
  }
  .service-card-step-more {
    font-size: 0.85rem;
    color: var(--theme-muted-foreground);
    margin-left: var(--space-7);
  }
  .service-card-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-top: var(--space-4);
  }
  .service-card-faq-info {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--theme-muted-foreground);
    font-size: 0.85rem;
    margin-top: var(--space-4);
  }
  .service-card-faq-icon {
    width: 16px;
    height: 16px;
    margin-right: var(--space-1);
  }
  .service-card-faq-text {}
  .service-card-action-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-top: var(--space-4);
  }
  .service-card-price-block {}
  .service-card-price {
    font-size: 2rem;
    font-weight: bold;
    color: var(--theme-primary);
  }
  .service-card-price-unit {
    font-size: 1rem;
    color: var(--theme-muted-foreground);
    margin-left: var(--space-1);
  }
  .service-card-action-icon {
    width: 16px;
    height: 16px;
    margin-left: var(--space-2);
  }
  .service-card-star {
    width: 16px;
    height: 16px;
    color: var(--theme-star-muted);
    transition: color 0.2s;
  }
  .service-card-star.active {
    color: var(--theme-star);
  }
  /* Variantes */
  .service-card.variant-default {
    background: var(--theme-card);
    color: var(--theme-card-foreground);
    box-shadow: var(--shadow-sm);
  }
  .service-card.variant-primary {
    background: var(--theme-primary);
    color: var(--theme-on-primary);
    box-shadow: var(--shadow-md);
  }
  .service-card.variant-secondary {
    background: var(--theme-secondary);
    color: var(--theme-on-secondary);
    box-shadow: var(--shadow-md);
  }
</style>